language: python


stages:
# Testing stage for all commits on all branches except tags
  - name: test
# Pypi deploy if tagged
  - name: pypi_deploy
    if: tag =~ ^\d+\.\d+\.\d+$
# Anaconda deploy if tagged and deployed to pypi
  - name: anaconda_deploy
    if: tag =~ ^\d+\.\d+\.\d+$


install:
    - pip install coverage flake8 twine


jobs:
  include:
    # Python 3.5
    - stage: test
      script:
        - python --version
        - python setup.py install
        - coverage run --rcfile coverage.cfg setup.py test
        - coverage report -m
        - flake8
      python:
        - 3.5
    - stage: pypi_deploy
      script:
        - export SETUP_VERSION=$(python ./setup.py --version)
        - if [ $SETUP_VERSION == $TRAVIS_BRANCH ]; then echo "Versions match..."; else echo "Version in setup does not match tag" && sleep 5 && exit 1; fi
        - python setup.py sdist
        - twine upload -u $PIP_USERNAME -p $PIP_PASSWORD dist/*
      python:
        - 3.5
    - stage: anaconda_deploy
      script:
        - echo "anaconda deploy"
      python:
        - 3.5
      # Python 3.6
    - stage: test
      script:
        - python --version
        - python setup.py install
        - coverage run --rcfile coverage.cfg setup.py test
        - coverage report -m
        - flake8
      python:
        - 3.6
    - stage: pypi_deploy
      script:
        - echo "pypi deploy"
      python:
        - 3.6
    - stage: anaconda_deploy
      script:
        - echo "anaconda deploy"
      python:
        - 3.6
    # Python 3.7 - Use workaround to get 3.7 to work - https://github.com/travis-ci/travis-ci/issues/9815
    - stage: test
      script:
        - python --version
        - python setup.py install
        - coverage run --rcfile coverage.cfg setup.py test
        - coverage report -m
        - flake8
      python:
        - 3.7
      dist: xenial
      sudo: true
    - stage: pypi_deploy
      script:
        - echo "pypi deploy"
      python:
        - 3.7
      dist: xenial
      sudo: true
    - stage: anaconda_deploy
      script:
        - echo "anaconda deploy"
      python:
        - 3.7
      dist: xenial
      sudo: true